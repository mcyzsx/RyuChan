---
// 仅浏览器执行：等 DOM + 首图加载完 → 绑定 → 解锁点击
---

<script>
  async function getFancybox() {
    if (window.Fancybox) return window.Fancybox;
    const ui = await import("@fancyapps/ui");
    return ui.Fancybox;
  }

  async function initFancybox() {
    const F = await getFancybox();
    if (!F) return;

    /* ① 等 DOM */
    await new Promise((res) => {
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", res);
      } else res(void 0);
    });

    /* ② 等第一张图加载完（防止空 masonry）*/
    const firstImg = document.querySelector(".masonry-grid img");
    if (firstImg && !firstImg.complete) {
      await Promise.race([
        new Promise((res) => firstImg.addEventListener("load", res, { once: true })),
        new Promise((res) => firstImg.addEventListener("error", res, { once: true })),
      ]);
    }

    /* ③ 绑定灯箱 */
    F.bind("[data-fancybox='gallery']", {
      animated: false,
      showClass: false,
      hideClass: false,
      dragToClose: true,
      showCounter: true,
      Image: { click: "toggleZoom", wheel: "toggleZoom", fit: "contain" },
      on: {
        done: (fb) => {
          const curr = fb.getSlide();
          const fig = curr.$trigger?.closest("figure");
          if (!fig) return;
          const desc = fig.dataset.description || "";
          const dim = fig.dataset.dimensions || "";
          const loc = fig.dataset.location || "";
          const tag = fig.dataset.tags || "";
          curr.caption = [desc, dim, loc, tag].filter(Boolean).join(" / ");
        },
      },
    });

    /* ④ 解锁点击 */
    document.querySelector(".masonry-grid")?.setAttribute("data-ready", "true");
    console.log("[debug] 灯箱绑定完成，点击已解锁");
  }

  initFancybox().catch((err) => console.error("Fancybox 初始化失败", err));
</script>
