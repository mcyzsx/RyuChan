---
/* 0. å¼•å…¥ï¼šå®Œå…¨æ²¿ç”¨ä½ å…¬å‘Šæ çš„ Card ä¸æ ·å¼ä½“ç³» */
import Card from "../temple/Card.astro";
import { Icon } from "astro-icon/components";

/* 1. æ•°æ®è·å–ï¼šç›´æ¥ç”¨ä½ ç°æˆçš„å·¥å…·å‡½æ•° */
import { getAllPosts, getTagsWithCount, getCategoriesWithPosts } from "../../utils/blogUtils";

const posts = await getAllPosts(); // æ–‡ç« 
const tagMap = getTagsWithCount(posts); // æ ‡ç­¾
const cateMap = getCategoriesWithPosts(posts); // åˆ†ç±»

/* 2. å­—æ•°ç»Ÿè®¡ï¼šä¸­è‹±åˆ†åˆ«ç®— */
let totalWords = 0;
posts.forEach((p) => {
  if (!p.body) return;
  const txt = p.body.replace(/\s+/g, " ").trim();
  const cn = txt.match(/[\u4e00-\u9fa5]/g)?.length || 0;
  const en = txt.match(/[a-zA-Z]+/g)?.length || 0;
  totalWords += cn + en;
});

/* 3. è¿è¡Œå¤©æ•° & æœ€åæ›´æ–°ï¼šå†™æ­»èµ·ç‚¹ï¼Œå®¢æˆ·ç«¯è¡¥åŠ¨æ€ */
const siteStartDate = "2025-11-15"; // å’Œä½  config ä¿æŒä¸€è‡´
const lastPubDate = posts[0]?.data.pubDate ?? new Date();

/* 4. ç»Ÿè®¡é¡¹ï¼šlabel ç›´æ¥å†™ä¸­æ–‡ï¼Œå›¾æ ‡ç”¨ Material çº¿æ€§ç‰ˆ */
const stats = [
  { icon: "material-symbols:article-outline", label: "æ–‡ç« ", value: posts.length },
  { icon: "material-symbols:folder-outline", label: "åˆ†ç±»", value: cateMap.size },
  { icon: "material-symbols:label-outline", label: "æ ‡ç­¾", value: tagMap.size },
  { icon: "material-symbols:text-ad-outline-rounded", label: "æ€»å­—æ•°", value: totalWords.toLocaleString("zh-CN") },
  { icon: "material-symbols:calendar-clock-outline", label: "è¿è¡Œå¤©æ•°", value: 0, id: "running-days" },
  { icon: "material-symbols:ecg-heart-outline", label: "æœ€åæ›´æ–°", value: 0, id: "last-update" },
];
---

<Card>
  <div class="site-stats-widget p-4">
    <div class="stats-header mb-3">
      <h3 class="text-lg font-semibold flex items-center gap-2">
        <span class="text-xl">ğŸ“Š</span>
        <span>ç«™ç‚¹ç»Ÿè®¡</span>
      </h3>
    </div>

    <div class="flex flex-col gap-2">
      {
        stats.map((s) => (
          <div
            class="flex items-center justify-between px-3 py-1.5 rounded-lg bg-[rgba(var(--c-bg-soft-rgb),0.6)]
                    border border-[rgba(var(--c-border-rgb),0.12)] hover:border-[rgba(var(--c-primary-rgb),0.4)]
                    transition-all duration-300"
          >
            <div class="flex items-center gap-2.5">
              <span class="text-[var(--c-primary)] text-xl">
                <Icon name={s.icon} />
              </span>
              <span class="text-sm font-medium text-[var(--c-text-1)]">{s.label}</span>
            </div>
            <span class="text-base font-bold text-[var(--c-text-1)]" data-stat-id={s.id}>
              {s.value}
            </span>
          </div>
        ))
      }
    </div>
  </div>
</Card>

<!-- å®¢æˆ·ç«¯è„šæœ¬ï¼šåªæ›´æ–°ä¸¤ä¸ªåŠ¨æ€å€¼ -->
<script define:vars={{ siteStartDate, lastPubDate }}>
  (function () {
    const today = new Date();
    const start = new Date(siteStartDate);
    const running = Math.floor((today - start) / 86_400_000);
    const last = new Date(lastPubDate);
    const daysAgo = Math.floor((today - last) / 86_400_000);

    const runEl = document.querySelector('[data-stat-id="running-days"]');
    const updEl = document.querySelector('[data-stat-id="last-update"]');
    if (runEl) runEl.textContent = running;
    if (updEl) updEl.textContent = daysAgo + " å¤©å‰";
  })();
</script>

<style lang="scss">
  /* ç›´æ¥æ²¿ç”¨ä½  Announcement çš„åŠ¨æ•ˆä¸é…è‰²å˜é‡ï¼Œæ— éœ€é‡å†™ */
  .site-stats-widget {
    .stats-header {
      border-bottom: 1px solid rgba(var(--c-border-rgb), 0.1);
      padding-bottom: 0.75rem;
      h3 {
        color: var(--c-text-1);
        font-family: var(--font-primary);
      }
    }
  }
</style>
